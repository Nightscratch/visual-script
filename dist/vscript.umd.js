(function(o,i){typeof exports=="object"&&typeof module<"u"?i(exports):typeof define=="function"&&define.amd?define(["exports"],i):(o=typeof globalThis<"u"?globalThis:o||self,i(o.vscript={}))})(this,function(o){"use strict";const i=s=>s.getBoundingClientRect();function p(s,e){let n=i(s),t=i(e);s.style.left=`${n.left-t.left}px`,s.style.top=`${n.top-t.top}px`}function m(s){let e=!1,n=0,t=0,l=null;function c(d){s.draggableBlock.includes(d.target)&&(e=!0,l=i(s.element),s.parentInput&&p(s.element,s.space.element),s.displayElement.classList.add("drag-block"),s.dragStart(),n=d.clientX-l.left,t=d.clientY-l.top,y())}function r(d){if(e){const k=d.clientX-n,x=d.clientY-t;s.element.style.left=`${k}px`,s.element.style.top=`${x}px`}}function a(){e=!1,s.displayElement.classList.remove("drag-block"),s.dragEnd(),E()}function y(){document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}function E(){document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)}s.element.addEventListener("mousedown",c)}const f=s=>{let e=null;s.element.addEventListener("contextmenu",n=>{if(!s.draggableBlock.includes(n.target))return;if(n.preventDefault(),e){document.body.removeChild(e),e=null;return}e=document.createElement("div"),e.style.position="absolute",e.style.left=`${n.clientX}px`,e.style.top=`${n.clientY}px`;const t=document.createElement("button");t.innerText="复制",t.addEventListener("click",()=>{s.copy()}),e.appendChild(t);const l=document.createElement("button");l.addEventListener("click",()=>{s.delete()}),l.innerText="删除",e.appendChild(l),document.body.appendChild(e)}),document.addEventListener("click",n=>{e&&!s.element.contains(n.target)&&(document.body.removeChild(e),e=null)})},h=(s,e)=>{const n=i(s),t=i(e);return{dis:Math.round(Math.abs(t.left-n.left)+Math.abs(t.top-n.top)),e1:n,e2:t}};class u{constructor(e){this.parentInput=null,this.draggableBlock=[],!e.create&&e.element&&(this.element=e.element)}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.displayElement=this.element.querySelector('[id="block-display"]')}dragEnd(){const e=this.getSmallestChild(),n=[];for(const t of this.space.blocks)if(t!=this)for(const[l,c]of Object.entries(t.inputs)){const r=h(c.element,this.element);if(r.dis<25)n.push({inputId:l,distance:r.dis,block:t,down:null});else if(l==="next"&&!t.parentInput){const a=h(t.element,e.element);Math.abs(a.e1.left-a.e2.left)<25&&Math.abs(a.e1.top-a.e2.bottom)<25&&n.push({inputId:l,distance:r.dis,block:t,down:e})}}if(n.length>0){const t=n.reduce((l,c)=>c.distance<l.distance?c:l);this.handleConnect(t.block.inputs[t.inputId],t)}}dragStart(){this.element.classList.remove("input-block"),this.space.element.appendChild(this.element),this.parentInput&&(this.parentInput.value=null),this.parentInput=null}solitary(){this.parentInput&&(this.parentInput.value=null),p(this.element,this.space.element),this.dragStart()}enterInput(e){e.value=this,e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e}getSmallestChild(){let e=this;for(;e.inputs.next.value instanceof u;)e=e.inputs.next.value;return e}handleConnect(e,n){if(n.down&&n.block!=this)n.block.enterInput(n.down.inputs.next);else{let t=null;e.value&&(t=e.value,t.solitary()),this.enterInput(e),t&&this.inputs.next&&t.enterInput(this.getSmallestChild().inputs.next)}}clone(){return new this.space.blockClasses[this.constructor.name]({create:!0})}copy(e=!0){e&&(this.parentInput=null);let n=this.clone();return this.space.addBlock(n),Object.keys(this.inputs).forEach(t=>{if(this.inputs[t].value instanceof u){console.log(this.inputs[t]);let l=this.inputs[t].value.copy(!1);n.inputs[t].value=l,l.enterInput(n.inputs[t])}else n.inputs[t].value=this.inputs[t].value}),n}delete(e=!0){e&&this.element.remove(),this.parentInput&&(this.parentInput.value=null),this.space.removeBlock(this),Object.keys(this.inputs).forEach(n=>{this.inputs[n].value instanceof u&&this.inputs[n].value.delete(!1)})}}class v extends u{constructor(e){super(e),this.inputs={step:{type:"input",value:null,element:null},next:{type:"next",value:null,element:null}},this.blockName="moveBlock",this.create()}create(){this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.element.innerHTML=`
        <div id="block-display" drag="true">
            <p class="block-text" drag="true">action</p>
            <div class="block-input" id="input-step"></div>
        </div>
        <div class="next-input" id="input-next"></div>
        `.replace(" ",""),this.getInput()}}const g=Object.freeze(Object.defineProperty({__proto__:null,Block:u,MoveBlock:v},Symbol.toStringTag,{value:"Module"}));class b{constructor(e){this.blocks=[],this.blockClasses={},this.element=e.element}addBlock(e){e.space=this,this.blocks.push(e),this.element.appendChild(e.element),m(e),f(e)}removeBlock(e){this.blocks.splice(this.blocks.indexOf(e),1)}registerBlock(e){this.blockClasses[e.name]=e}}o.VisualBlock=b,o.blocks=g,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
