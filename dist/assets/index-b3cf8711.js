var E=Object.defineProperty;var x=(s,e,t)=>e in s?E(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>(x(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))n(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerPolicy&&(i.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?i.credentials="include":l.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(l){if(l.ep)return;l.ep=!0;const i=t(l);fetch(l.href,i)}})();const d=s=>s.getBoundingClientRect();function h(s,e){let t=d(s),n=d(e);s.style.left=`${t.left-n.left}px`,s.style.top=`${t.top-n.top}px`}function L(s){let e=!1,t=0,n=0,l=null;function i(c){s.draggableBlock.includes(c.target)&&(e=!0,l=d(s.element),s.parentInput&&h(s.element,s.space.element),s.displayElement.classList.add("drag-block"),s.dragStart(),t=c.clientX-l.left,n=c.clientY-l.top,v())}function r(c){if(e){const y=c.clientX-t,b=c.clientY-n;s.element.style.left=`${y}px`,s.element.style.top=`${b}px`}}function a(){e=!1,s.displayElement.classList.remove("drag-block"),s.dragEnd(),g()}function v(){document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}function g(){document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a)}s.element.addEventListener("mousedown",i)}const k=s=>{let e=null;s.element.addEventListener("contextmenu",t=>{if(!s.draggableBlock.includes(t.target))return;if(t.preventDefault(),e){document.body.removeChild(e),e=null;return}e=document.createElement("div"),e.style.position="absolute",e.style.left=`${t.clientX}px`,e.style.top=`${t.clientY}px`;const n=document.createElement("button");n.innerText="复制",n.addEventListener("click",()=>{s.copy()}),e.appendChild(n);const l=document.createElement("button");l.addEventListener("click",()=>{s.delete()}),l.innerText="删除",e.appendChild(l),document.body.appendChild(e)}),document.addEventListener("click",t=>{e&&!s.element.contains(t.target)&&(document.body.removeChild(e),e=null)})};class C{constructor(e){o(this,"element");o(this,"blocks",[]);o(this,"blockClasses",{});this.element=e.element}addBlock(e){e.space=this,this.blocks.push(e),this.element.appendChild(e.element),L(e),k(e)}removeBlock(e){this.blocks.splice(this.blocks.indexOf(e),1)}registerBlock(e){this.blockClasses[e.name]=e}}const m=(s,e)=>{const t=d(s),n=d(e);return{dis:Math.round(Math.abs(n.left-t.left)+Math.abs(n.top-t.top)),e1:t,e2:n}};class u{constructor(e){o(this,"element");o(this,"inputs");o(this,"space");o(this,"parentInput",null);o(this,"draggableBlock",[]);o(this,"displayElement");o(this,"blockName");!e.create&&e.element&&(this.element=e.element)}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.displayElement=this.element.querySelector('[id="block-display"]')}dragEnd(){const e=this.getSmallestChild(),t=[];for(const n of this.space.blocks)if(n!=this)for(const[l,i]of Object.entries(n.inputs)){const r=m(i.element,this.element);if(r.dis<25)t.push({inputId:l,distance:r.dis,block:n,down:null});else if(l==="next"&&!n.parentInput){const a=m(n.element,e.element);Math.abs(a.e1.left-a.e2.left)<25&&Math.abs(a.e1.top-a.e2.bottom)<25&&t.push({inputId:l,distance:r.dis,block:n,down:e})}}if(t.length>0){const n=t.reduce((l,i)=>i.distance<l.distance?i:l);this.handleConnect(n.block.inputs[n.inputId],n)}}dragStart(){this.element.classList.remove("input-block"),this.space.element.appendChild(this.element),this.parentInput&&(this.parentInput.value=null),this.parentInput=null}solitary(){this.parentInput&&(this.parentInput.value=null),h(this.element,this.space.element),this.dragStart()}enterInput(e){e.value=this,e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e}getSmallestChild(){let e=this;for(;e.inputs.next.value instanceof u;)e=e.inputs.next.value;return e}handleConnect(e,t){if(t.down&&t.block!=this)t.block.enterInput(t.down.inputs.next);else{let n=null;e.value&&(n=e.value,n.solitary()),this.enterInput(e),n&&this.inputs.next&&n.enterInput(this.getSmallestChild().inputs.next)}}clone(){return new this.space.blockClasses[this.constructor.name]({create:!0})}copy(e=!0){e&&(this.parentInput=null);let t=this.clone();return this.space.addBlock(t),Object.keys(this.inputs).forEach(n=>{if(this.inputs[n].value instanceof u){console.log(this.inputs[n]);let l=this.inputs[n].value.copy(!1);t.inputs[n].value=l,l.enterInput(t.inputs[n])}else t.inputs[n].value=this.inputs[n].value}),t}delete(e=!0){e&&this.element.remove(),this.parentInput&&(this.parentInput.value=null),this.space.removeBlock(this),Object.keys(this.inputs).forEach(t=>{this.inputs[t].value instanceof u&&this.inputs[t].value.delete(!1)})}}class f extends u{constructor(e){super(e),this.inputs={step:{type:"input",value:null,element:null},next:{type:"next",value:null,element:null}},this.blockName="moveBlock",this.create()}create(){this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.element.innerHTML=`
        <div id="block-display" drag="true">
            <p class="block-text" drag="true">action</p>
            <div class="block-input" id="input-step"></div>
        </div>
        <div class="next-input" id="input-next"></div>
        `.replace(" ",""),this.getInput()}}let p=new C({element:document.getElementById("blocklyDiv")});p.registerBlock(f);p.addBlock(new f({create:!0}));window.app=p;
