(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&l(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();function D(s,e){return[s.getBoundingClientRect(),e.getBoundingClientRect()]}const m=(s,e,t,l)=>{const n=s.getBoundingClientRect();L(s,e,n.left+t,n.top+l)},L=(s,e,t,l)=>{const n=e.getBoundingClientRect();s.style.left=`${e.scrollLeft+t-n.left}px`,s.style.top=`${e.scrollTop+l-n.top}px`},I=(s,e)=>{m(s,e,0,0)},$=(s,e)=>{const[t,l]=D(s,e);return{top:t.top-l.top+e.scrollTop,left:t.left-l.left+e.scrollLeft}},j=(s,e=!1)=>{let t,l,n=0,i=0,o=s.space;o.element.getBoundingClientRect();let c=!1;const d=a=>{o.dropDown.close(),!((!s.draggableBlock.includes(a.target)||a.button!==0)&&!e)&&(c=!0,s.element.getBoundingClientRect(),s.parentInput&&I(s.element,o.blockSpace),s.displayElement.classList.add("drag-block"),s.dragStart(),t=a.clientX,l=a.clientY,s.element.style.left?(n=parseInt(s.element.style.left),i=parseInt(s.element.style.top)):(n=0,i=0),P())},h=a=>{if(c){var T=a.clientX-t,O=a.clientY-l;n+=T/o.zoom,i+=O/o.zoom,s.element.style.left=`${n}px`,s.element.style.top=`${i}px`,t=a.clientX,l=a.clientY,a.preventDefault()}},u=()=>{c=!1,s.displayElement.classList.remove("drag-block"),s.dragEnd(),o.setPlaceholder(),N()},P=()=>{document.addEventListener("mousemove",h),document.addEventListener("mouseup",u)},N=()=>{document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",u)};s.element.addEventListener("mousedown",d);function y(a){document.removeEventListener("mousemove",y),d(a),e=!1}e&&document.addEventListener("mousemove",y)};function H(s){var e=!1,t,l;s.element.addEventListener("mousedown",n),s.element.addEventListener("mouseup",i),s.element.addEventListener("mousemove",o);function n(c){c.target==s.scrollPlaceholder&&(e=!0,t=c.clientX,l=c.clientY,c.preventDefault())}function i(){e=!1}function o(c){if(e){var d=c.clientX-t,h=c.clientY-l;s.element.scrollLeft-=d,s.element.scrollTop-=h,t=c.clientX,l=c.clientY,c.preventDefault()}}s.element.addEventListener("mouseleave",()=>{e=!1})}class R{constructor(){this.element=document.createElement("div"),this.element.classList.add("drop-down"),this.close(),document.addEventListener("click",e=>{this.close()})}createButton(e){const t=document.createElement("button");return t.innerText=e.text,t.addEventListener("click",e.click),t}setButton(e){this.element.innerHTML="",e.forEach(t=>{this.element.appendChild(this.createButton(t))}),this.element.style.display="block"}close(){this.element.style.display="none"}moveTo(e,t){this.element.style.left=`${e}px`,this.element.style.top=`${t}px`}}const A=(s,e)=>{s.element.addEventListener("contextmenu",t=>{s.draggableBlock.includes(t.target)&&(t.preventDefault(),e.moveTo(t.clientX,t.clientY),e.setButton([{text:"复制积木",click:()=>{s.copy()}},{text:"删除积木",click:()=>{s.delete()}}]))})},X=s=>{s.element.addEventListener("contextmenu",e=>{e.target==s.scrollPlaceholder&&(e.preventDefault(),s.dropDown.moveTo(e.clientX,e.clientY),s.dropDown.setButton([{text:"删除全部",click:()=>{s.clean()}},{text:"整理积木",click:()=>{s.arrange()}}]))})},Y=s=>{let e=document.createElement("div");return e.classList.add("zoom-list"),s.forEach(t=>{let l=document.createElement("button");l.classList.add("zoom-btn"),l.innerText=t.text,l.addEventListener("click",()=>{t.click()}),e.appendChild(l)}),e};class q{constructor(e){this.blocks=[],this.blockClasses={},this.zoom=1,this.element=e.element,e.zoomElement.appendChild(Y([{text:"＋",click:()=>{this.zoom+=.4,this.setZoom()}},{text:"＝",click:()=>{this.zoom=1,this.setZoom()}},{text:"－",click:()=>{this.zoom-=.4,this.setZoom()}}])),this.scrollPlaceholder=document.createElement("div"),this.scrollPlaceholder.classList.add("placeholder"),this.element.append(this.scrollPlaceholder),this.blockSpace=document.createElement("div"),this.blockSpace.classList.add("block-container-space"),this.element.appendChild(this.blockSpace),this.dropDown=new R,document.body.appendChild(this.dropDown.element),X(this),H(this),this.setZoom()}setZoom(e=this.zoom){this.zoom=Math.min(Math.max(e,.5),2.5),this.blockSpace.setAttribute("style",`zoom:${this.zoom}`),this.scrollPlaceholder.setAttribute("style",`zoom:${this.zoom}`),this.setPlaceholder()}setPlaceholder(){let e=this.element.scrollLeft,t=this.element.scrollTop;this.scrollPlaceholder.style.display="none",this.scrollPlaceholder.style.height=`${(this.element.scrollHeight+this.element.clientHeight/2)/this.zoom}px`,this.scrollPlaceholder.style.width=`${(this.element.scrollWidth+this.element.clientWidth/2)/this.zoom}px`,this.scrollPlaceholder.style.display="block",this.element.scrollLeft=e,this.element.scrollTop=t}addBlock(e,t=!1){e.space=this,this.blocks.push(e),this.blockSpace.appendChild(e.element),j(e,t),A(e,this.dropDown)}removeBlock(e){this.blocks.splice(this.blocks.indexOf(e),1)}registerBlock(e){let t=new e({create:!0});this.blockClasses[t.blockType]=e}load(e){return new Promise((t,l)=>{for(const n of JSON.parse(e)){let i=new this.blockClasses[n.blockType]({create:!0});this.addBlock(i),i.loadInputs(n,!0)}t()})}save(){return new Promise(e=>{let t=[];for(const[l,n]of Object.entries(this.blocks))n.parentInput||t.push(n.toJson(!1));e(t)})}clean(){return new Promise(e=>{this.blockSpace.innerHTML="",this.blocks=[],e()})}arrange(){return new Promise((e,t)=>{let l=10,n=10;for(const[i,o]of Object.entries(this.blocks))o.parentInput||(o.element.style.left=`${l}px`,o.element.style.top=`${n}px`,n+=o.element.clientHeight+10);this.setPlaceholder(),e()})}}const x=(s,e)=>{const t=s.getBoundingClientRect(),l=e.getBoundingClientRect();return{dis:Math.round(Math.abs(l.left-t.left)+Math.abs(l.top-t.top)),e1:t,e2:l}};var r=(s=>(s[s.method=0]="method",s[s.next=1]="next",s[s.input=2]="input",s[s.singleInput=3]="singleInput",s))(r||{}),b=(s=>(s[s.prevent=0]="prevent",s[s.normal=1]="normal",s[s.kick=2]="kick",s))(b||{});class p{constructor(e){this.parentInput=null,this.draggableBlock=[],!e.create&&e.element&&(this.element=e.element),this.inputs=e.inputs,this.element||(this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.create()),this.blockType=e.blockType,this.hat=e.hat,this.defaultInsert=e.defaultInsert,this.getInput()}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.draggableBlock.push(this.element),this.displayElement=this.element.querySelector('[id="block-display"]')}dragEnd(){const e=this.getSmallestChild(),t=[];for(const l of this.space.blocks)if(l!=this&&!this.element.contains(l.element)){if(!this.hat)for(const[n,i]of Object.entries(l.inputs)){let o=l.newInputCheack(this,n),c=this.enterInputCheack(l,n);if(o!=0&&c!=0){const d=x(i.element,this.element);d.dis<25&&t.push({inputId:n,distance:d.dis,block:l,type:Math.max(c,o),down:null})}}for(const[n,i]of Object.entries(this.inputs))if([1,0].includes(i.type)&&!l.parentInput&&!l.hat){let o,c;i.type==1?(o=e,c=e):(o=this.inputs[n],c=this);let d=l.enterInputCheack(c,n),h=c.newInputCheack(l,n);if(d!=0&&h!=0){let u=x(l.element,o.element);Math.abs(u.e1.left-u.e2.left)<25&&Math.abs(u.e1.top-u.e2.bottom)<25&&t.push({inputId:n,distance:u.dis,block:l,type:Math.max(h,d),down:c})}}}if(t.length>0){const l=t.reduce((n,i)=>i.distance<n.distance?i:n);this.handleConnect(l.block.inputs[l.inputId],l)}}newInputCheack(e,t){return 1}enterInputCheack(e,t){return 1}dragStart(){this.element.classList.remove("input-block"),this.space.blockSpace.appendChild(this.element),this.detachFromParent()}solitary(){I(this.element,this.space.blockSpace),this.dragStart()}enterInput(e){e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e,e.value=this}cheackAndEnterInput(e,t,l){this.enterInputCheack(e,t)&&e.newInputCheack(this,t)?this.enterInput(e.inputs[t]):l&&l()}getSmallestChild(e="next"){let t=this;for(;t.inputs[e]&&t.inputs[e].value instanceof p;)t=t.inputs[e].value,e="next";return t}handleConnect(e,t){if(t.down&&t.block!=this)t.block.enterInput(t.down.inputs[t.inputId]);else{console.log(t,e);let l=null;e.value&&(l=e.value,l.solitary()),this.enterInput(e),l&&(t.type==2?m(l.element,this.space.element,25,25):this.defaultInsert&&(l=l,this.inputs[this.defaultInsert].type==0&&!(this.inputs[this.defaultInsert].value instanceof p)?l.cheackAndEnterInput(this,this.defaultInsert,()=>m(l.element,this.space.element,25,25)):l.cheackAndEnterInput(this.getSmallestChild(),"next",()=>m(l.element,this.space.element,25,25))))}}detachFromParent(){this.parentInput&&(this.parentInput.value=null),this.parentInput=null}clone(e){let t=this.element.cloneNode(!0);if(t.querySelectorAll('div[id^="input-"]').forEach(i=>{i.innerHTML=""}),e){t.classList.remove("input-block");const i=$(this.element,this.space.blockSpace);t.style.left=`${i.left+25}px`,t.style.top=`${i.top+25}px`}let n=new this.space.blockClasses[this.blockType]({create:!1,element:t});return e&&(n.parentInput=null),n}copy(e=!0){let t=this.clone(e);return this.space.addBlock(t),Object.keys(this.inputs).forEach(l=>{if(this.inputs[l].value instanceof p){let n=this.inputs[l].value.copy(!1);t.inputs[l].value=n,n.enterInput(t.inputs[l])}else t.inputs[l].value=this.inputs[l].value}),t}delete(e=!0){e&&this.element.remove(),this.parentInput&&(this.parentInput.value=null),this.space.removeBlock(this),Object.keys(this.inputs).forEach(t=>{this.inputs[t].value instanceof p&&this.inputs[t].value.delete(!1)})}toJson(e=!0){let t={blockType:this.blockType,inputs:{}};return e&&(t.left=parseInt(this.element.style.left),t.top=parseInt(this.element.style.top)),this.saveProperties(t),Object.keys(this.inputs).forEach(l=>{this.inputs[l].value instanceof p?t.inputs[l]={type:"block",value:this.inputs[l].value.toJson(!1)}:this.inputs[l].value instanceof String&&(t.inputs[l]={type:"text",value:this.inputs[l].value})}),t}saveProperties(e){}loadProperties(e){}loadInputs(e,t=!0){t&&(this.element.style.left=`${e.left}px`,this.element.style.top=`${e.top}px`),this.loadProperties(e);for(const[l,n]of Object.entries(e.inputs))if(n.type=="block"){let i=n.value,o=new this.space.blockClasses[i.blockType]({create:!0});this.space.addBlock(o),n.value&&o.loadInputs(n.value,!1).enterInput(this.inputs[l])}return this}}class Z extends p{constructor(e){super(e)}enterInputCheack(e,t){return[r.singleInput,r.input].includes(e.inputs[t].type)?b.kick:b.prevent}}class C extends Z{constructor(e){e.inputs={number1:{type:r.input},number2:{type:r.input}},e.blockType="AddBlock",super(e),this.prohibitBlock=!0,this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line green block-round">
                <div class="block-input" id="input-number1" drag="true"></div>
                <p class="block-text" drag="true">+</p>
                <div class="block-input" id="input-number2" drag="true"></div>
            </div>
            `.replace(" ","")}}class M extends p{constructor(e){e.inputs={next:{type:r.next}},e.blockType="StartBlock",super(e),this.defaultInsert="next",this.hat=!0}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line block-hat yellow">
                <p class="block-text" drag="true">程序开始运行</p>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}class B extends p{constructor(e){e.inputs={y:{type:r.input},x:{type:r.input},next:{type:r.next}},e.blockType="MoveBlock",super(e),this.defaultInsert="next",this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line blue">
                <p class="block-text" drag="true">移动到</p>
                <div class="block-input" id="input-x" drag="true"></div>
                <div class="block-input" id="input-y" drag="true"></div>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}class w extends p{constructor(e){e.inputs={condition:{type:r.input},if:{type:r.method},else:{type:r.method},next:{type:r.next}},e.blockType="IfBlock",super(e),this.defaultInsert="if",this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="yellow"> 
                <div class="block-line block-method">
                    <p class="block-text" drag="true">如果</p>
                    <div class="block-input" id="input-condition" drag="true"></div>
                    <p class="block-text" drag="true">那么</p>
                </div>
                <div class="block-block-input" id="input-if" drag="true"></div>
                
                <div class="block-line block-method">
                    <p class="block-text" drag="true">否则</p>
                </div>
                <div class="block-block-input" id="input-else"></div>
                <div class="block-line block-method">
                    <p class="block-text" drag="true">end</p>
                </div>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}const E=Object.freeze(Object.defineProperty({__proto__:null,AddBlock:C,IfBlock:w,MoveBlock:B,StartBlock:M},Symbol.toStringTag,{value:"Module"}));class J{constructor(e){this.space=e}load(e){console.log(e.element),this.space.blocks=e.block,this.space.blockSpace.innerHTML="",e.element.forEach(t=>{this.space.blockSpace.appendChild(t)})}empty(){this.space.blocks=[],this.space.blockSpace.innerHTML=""}}class S{constructor(){this.element=[],this.block=[]}load(e){debugger;this.block=e.blocks,console.log("space.blockSpace.childNodes",e.blockSpace.childNodes),e.blockSpace.childNodes.forEach(t=>{console.log(t),this.element.push(t)})}}const F=`<div class="sprite">\r
    <p id="name"></p>\r
    <button id="del">删除</button>\r
    <button id="rename">重命名</button>\r
</div>`,z=s=>{let e=document.createElement("div");return e.innerHTML=s,e.firstChild};class v{constructor(e){e.block instanceof S?this.block=e.block:this.block=new S,this.element=z(F),this.setName(e.spriteName)}setOnClick(e){this.element.addEventListener("click",t=>e(t))}setName(e){this.spriteName=e,this.element.querySelector("#name").innerText=this.spriteName}remove(){this.element.remove()}}class U{constructor(e){this.sprites=e.sprites,this.blockManager=e.blockManager,this.element=e.element,this.autoSelectSprite()}addSprite(e){this.sprites.push(e),this.element.appendChild(e.element),e.setOnClick(t=>{let l=t.target.getAttribute("id");l=="del"?this.removeSprite(e):l=="rename"?this.setSpriteName(String(prompt("取名",e.spriteName)),e):this.setSelectedSprite(e)}),this.autoSelectSprite()}setSpriteName(e,t){for(const l of this.sprites)if(l.spriteName==e){alert(`已有名叫${e}的角色了`);return}t.setName(e)}autoSelectSprite(){this.sprites.length==0?this.setSelectedSprite(null):this.setSelectedSprite(0)}save(){this.selectedSprite&&this.selectedSprite.block.load(this.blockManager.space)}removeSprite(e){e.remove(),this.sprites.splice(this.sprites.indexOf(e),1),this.selectedSprite==e&&this.sprites.length==0&&this.autoSelectSprite()}setSelectedSprite(e){let t=null;if(this.selectedSprite&&(this.selectedSprite.block.load(this.blockManager.space),this.selectedSprite.element.classList.remove("sprite-active")),typeof e=="number")t=this.sprites[e];else if(e instanceof v)t=e;else{this.selectedSprite=null,this.blockManager.empty();return}t.element.classList.add("sprite-active"),this.selectedSprite=t,this.blockManager.load(t.block)}}const W='<li><button id="btn"></button></li>';class G{constructor(e){this.categorizes=[],this.element=e.element,this.modelElement=e.modelElement,this.space=e.space,e.categorizes&&(e.categorizes.forEach(t=>{this.addCategorize(t)}),this.selectedCategorize=e.categorizes[0],this.setModel())}setModel(){if(this.selectedCategorize){this.modelElement.innerHTML="";for(const e of this.selectedCategorize.blocks){let t=new e({create:!0});t.element.classList.add("model-block"),this.modelElement.appendChild(t.element),console.log("b.element",t.element),t.element.addEventListener("mousedown",l=>{let n=new e({create:!0}),i=t.element.getBoundingClientRect();L(n.element,this.space.element,i.left,i.top),this.space.addBlock(n,!0)})}}}addCategorize(e){this.categorizes.push(e),e.element.addEventListener("click",()=>{this.selectedCategorize=e,this.setModel()}),this.element.appendChild(e.element)}}class f{constructor(e){this.blocks=e.blocks,this.element=z(W),this.setName(e.categorizeName)}setName(e){this.categorizeName=e,this.element.querySelector("#btn").innerText=this.categorizeName}}let g=new q({element:document.getElementById("blockDiv"),zoomElement:document.getElementById("zoom")}),K=new J(g),k=new U({element:document.getElementById("sprite-list"),sprites:[],blockManager:K});k.addSprite(new v({spriteName:"角色0"}));for(const s in E)g.registerBlock(E[s]);new G({space:g,element:document.getElementById("tool-box"),modelElement:document.getElementById("code-model"),categorizes:[new f({categorizeName:"运动",blocks:[B]}),new f({categorizeName:"控制",blocks:[w,M]}),new f({categorizeName:"运算",blocks:[C]})]});document.getElementById("add").addEventListener("click",()=>{k.addSprite(new v({spriteName:"角色"+k.sprites.length}))});
