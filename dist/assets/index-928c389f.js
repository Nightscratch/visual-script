(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))n(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerPolicy&&(i.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?i.credentials="include":l.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(l){if(l.ep)return;l.ep=!0;const i=t(l);fetch(l.href,i)}})();function y(s,e){return[s.getBoundingClientRect(),e.getBoundingClientRect()]}const f=(s,e,t,n)=>{const[l,i]=y(s,e);s.style.left=`${l.left-i.left+e.scrollLeft+t}px`,s.style.top=`${l.top-i.top+e.scrollTop+n}px`},g=(s,e)=>{const[t,n]=y(s,e);s.style.left=`${t.left-n.left+e.scrollLeft}px`,s.style.top=`${t.top-n.top+e.scrollTop}px`},w=s=>{let e,t,n=0,l=0,i=s.space;i.element.getBoundingClientRect();let o=!1;const c=d=>{i.dropDown.close(),!(!s.draggableBlock.includes(d.target)||d.button!==0)&&(o=!0,s.element.getBoundingClientRect(),s.parentInput&&g(s.element,i.blockSpace),s.displayElement.classList.add("drag-block"),s.dragStart(),e=d.clientX,t=d.clientY,s.element.style.left?(n=parseInt(s.element.style.left),l=parseInt(s.element.style.top)):(n=0,l=0),h())},a=d=>{if(o){var E=d.clientX-e,L=d.clientY-t;n+=E/i.zoom,l+=L/i.zoom,s.element.style.left=`${n}px`,s.element.style.top=`${l}px`,e=d.clientX,t=d.clientY,d.preventDefault()}},p=()=>{o=!1,s.displayElement.classList.remove("drag-block"),s.dragEnd(),i.setPlaceholder(),I()},h=()=>{document.addEventListener("mousemove",a),document.addEventListener("mouseup",p)},I=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",p)};s.element.addEventListener("mousedown",c)};function C(s){var e=!1,t,n;s.element.addEventListener("mousedown",l),s.element.addEventListener("mouseup",i),s.element.addEventListener("mousemove",o);function l(c){c.target==s.scrollPlaceholder&&(e=!0,t=c.clientX,n=c.clientY,c.preventDefault())}function i(){e=!1}function o(c){if(e){var a=c.clientX-t,p=c.clientY-n;s.element.scrollLeft-=a,s.element.scrollTop-=p,t=c.clientX,n=c.clientY,c.preventDefault()}}s.element.addEventListener("mouseleave",()=>{e=!1})}class B{constructor(){this.element=document.createElement("div"),this.element.classList.add("drop-down"),this.close(),document.addEventListener("click",e=>{this.close()})}createButton(e){const t=document.createElement("button");return t.innerText=e.text,t.addEventListener("click",e.click),t}setButton(e){this.element.innerHTML="",e.forEach(t=>{this.element.appendChild(this.createButton(t))}),this.element.style.display="block"}close(){this.element.style.display="none"}moveTo(e,t){this.element.style.left=`${e}px`,this.element.style.top=`${t}px`}}const S=(s,e)=>{s.element.addEventListener("contextmenu",t=>{s.draggableBlock.includes(t.target)&&(t.preventDefault(),e.moveTo(t.clientX,t.clientY),e.setButton([{text:"复制积木",click:()=>{s.copy()}},{text:"删除积木",click:()=>{s.delete()}}]))})},M=s=>{s.element.addEventListener("contextmenu",e=>{e.target==s.scrollPlaceholder&&(e.preventDefault(),s.dropDown.moveTo(e.clientX,e.clientY),s.dropDown.setButton([{text:"删除全部",click:()=>{s.clean()}},{text:"整理积木",click:()=>{s.arrange()}}]))})},P=s=>{let e=document.createElement("div");return e.classList.add("zoom-list"),s.forEach(t=>{let n=document.createElement("button");n.classList.add("zoom-btn"),n.innerText=t.text,n.addEventListener("click",()=>{t.click()}),e.appendChild(n)}),e};class T{constructor(e){this.blocks=[],this.blockClasses={},this.zoom=1,this.element=e.element,e.zoomElement.appendChild(P([{text:"＋",click:()=>{this.zoom+=.4,this.setZoom()}},{text:"＝",click:()=>{this.zoom=1,this.setZoom()}},{text:"－",click:()=>{this.zoom-=.4,this.setZoom()}}])),this.scrollPlaceholder=document.createElement("div"),this.scrollPlaceholder.classList.add("placeholder"),this.element.append(this.scrollPlaceholder),this.blockSpace=document.createElement("div"),this.blockSpace.classList.add("block-container-space"),this.element.appendChild(this.blockSpace),window.test=this,this.dropDown=new B,document.body.appendChild(this.dropDown.element),M(this),C(this),this.setZoom()}setZoom(e=this.zoom){this.zoom=Math.min(Math.max(e,.5),2.5),this.blockSpace.setAttribute("style",`zoom:${this.zoom}`),this.scrollPlaceholder.setAttribute("style",`zoom:${this.zoom}`),this.setPlaceholder()}setPlaceholder(){let e=this.element.scrollLeft,t=this.element.scrollTop;this.scrollPlaceholder.style.display="none",this.scrollPlaceholder.style.height=`${(this.element.scrollHeight+this.element.clientHeight/2)/this.zoom}px`,this.scrollPlaceholder.style.width=`${(this.element.scrollWidth+this.element.clientWidth/2)/this.zoom}px`,this.scrollPlaceholder.style.display="block",this.element.scrollLeft=e,this.element.scrollTop=t}addBlock(e){e.space=this,this.blocks.push(e),this.blockSpace.appendChild(e.element),w(e),S(e,this.dropDown)}removeBlock(e){this.blocks.splice(this.blocks.indexOf(e),1)}registerBlock(e){let t=new e({create:!0});this.blockClasses[t.blockType]=e}load(e){return new Promise((t,n)=>{for(const l of JSON.parse(e)){let i=new this.blockClasses[l.blockType]({create:!0});this.addBlock(i),i.loadInputs(l,!0)}t()})}save(){return new Promise(e=>{let t=[];for(const[n,l]of Object.entries(this.blocks))l.parentInput||t.push(l.toJson(!1));e(t)})}clean(){return new Promise(e=>{this.blockSpace.innerHTML="",this.blocks=[],e()})}arrange(){return new Promise((e,t)=>{let n=10,l=10;for(const[i,o]of Object.entries(this.blocks))o.parentInput||(o.element.style.left=`${n}px`,o.element.style.top=`${l}px`,l+=o.element.clientHeight+10);this.setPlaceholder(),e()})}}const v=(s,e)=>{const t=s.getBoundingClientRect(),n=e.getBoundingClientRect();return{dis:Math.round(Math.abs(n.left-t.left)+Math.abs(n.top-t.top)),e1:t,e2:n}};var r=(s=>(s[s.method=0]="method",s[s.next=1]="next",s[s.input=2]="input",s[s.singleInput=3]="singleInput",s))(r||{}),k=(s=>(s[s.prevent=0]="prevent",s[s.normal=1]="normal",s[s.kick=2]="kick",s))(k||{});class u{constructor(e){this.parentInput=null,this.draggableBlock=[],!e.create&&e.element&&(this.element=e.element),this.inputs=e.inputs,this.element||(this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.create()),this.blockType=e.blockType,this.hat=e.hat,this.defaultInsert=e.defaultInsert,this.getInput()}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.displayElement=this.element.querySelector('[id="block-display"]')}dragEnd(){const e=this.getSmallestChild(),t=[];for(const n of this.space.blocks)if(n!=this&&!this.element.contains(n.element)){if(!this.hat)for(const[l,i]of Object.entries(n.inputs)){let o=n.newInputCheack(this,l),c=this.enterInputCheack(n,l);if(o!=0&&c!=0){const a=v(i.element,this.element);a.dis<25&&t.push({inputId:l,distance:a.dis,block:n,type:Math.max(c,o),down:null})}}for(const[l,i]of Object.entries(this.inputs))if([1,0].includes(i.type)&&!n.parentInput&&!n.hat){let o,c;i.type==1?(o=e,c=e):(o=this.inputs[l],c=this);let a=n.enterInputCheack(c,l),p=c.newInputCheack(n,l);if(a!=0&&p!=0){let h=v(n.element,o.element);Math.abs(h.e1.left-h.e2.left)<25&&Math.abs(h.e1.top-h.e2.bottom)<25&&t.push({inputId:l,distance:h.dis,block:n,type:Math.max(p,a),down:c})}}}if(t.length>0){const n=t.reduce((l,i)=>i.distance<l.distance?i:l);this.handleConnect(n.block.inputs[n.inputId],n)}}newInputCheack(e,t){return 1}enterInputCheack(e,t){return 1}dragStart(){this.element.classList.remove("input-block"),this.space.blockSpace.appendChild(this.element),this.detachFromParent()}solitary(){g(this.element,this.space.blockSpace),this.dragStart()}enterInput(e){e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e,e.value=this}cheackAndEnterInput(e,t,n){this.enterInputCheack(e,t)&&e.newInputCheack(this,t)?this.enterInput(e.inputs[t]):n&&n()}getSmallestChild(e="next"){let t=this;for(;t.inputs[e]&&t.inputs[e].value instanceof u;)t=t.inputs[e].value,e="next";return t}handleConnect(e,t){if(t.down&&t.block!=this)t.block.enterInput(t.down.inputs[t.inputId]);else{console.log(t,e);let n=null;e.value&&(n=e.value,n.solitary()),this.enterInput(e),n&&(t.type==2?f(n.element,this.space.element,25,25):this.defaultInsert&&(n=n,this.inputs[this.defaultInsert].type==0&&!(this.inputs[this.defaultInsert].value instanceof u)?n.cheackAndEnterInput(this,this.defaultInsert,()=>f(n.element,this.space.element,25,25)):n.cheackAndEnterInput(this.getSmallestChild(),"next",()=>f(n.element,this.space.element,25,25))))}}detachFromParent(){this.parentInput&&(this.parentInput.value=null),this.parentInput=null}clone(e){let t=this.element.cloneNode(!0);t.querySelectorAll('div[id^="input-"]').forEach(i=>{i.innerHTML=""}),e&&(t.classList.remove("input-block"),f(this.element,this.space.element,25,25));let l=new this.space.blockClasses[this.blockType]({create:!1,element:t});return e&&(l.parentInput=null),l}copy(e=!0){let t=this.clone(e);return this.space.addBlock(t),Object.keys(this.inputs).forEach(n=>{if(this.inputs[n].value instanceof u){let l=this.inputs[n].value.copy(!1);t.inputs[n].value=l,l.enterInput(t.inputs[n])}else t.inputs[n].value=this.inputs[n].value}),t}delete(e=!0){e&&this.element.remove(),this.parentInput&&(this.parentInput.value=null),this.space.removeBlock(this),Object.keys(this.inputs).forEach(t=>{this.inputs[t].value instanceof u&&this.inputs[t].value.delete(!1)})}toJson(e=!0){let t={blockType:this.blockType,inputs:{}};return e&&(t.left=parseInt(this.element.style.left),t.top=parseInt(this.element.style.top)),this.saveProperties(t),Object.keys(this.inputs).forEach(n=>{this.inputs[n].value instanceof u?t.inputs[n]={type:"block",value:this.inputs[n].value.toJson(!1)}:this.inputs[n].value instanceof String&&(t.inputs[n]={type:"text",value:this.inputs[n].value})}),t}saveProperties(e){}loadProperties(e){}loadInputs(e,t=!0){t&&(this.element.style.left=`${e.left}px`,this.element.style.top=`${e.top}px`),this.loadProperties(e);for(const[n,l]of Object.entries(e.inputs))if(l.type=="block"){let i=l.value,o=new this.space.blockClasses[i.blockType]({create:!0});this.space.addBlock(o),l.value&&o.loadInputs(l.value,!1).enterInput(this.inputs[n])}return this}}class O extends u{constructor(e){super(e)}enterInputCheack(e,t){return[r.singleInput,r.input].includes(e.inputs[t].type)?k.kick:k.prevent}}class z extends O{constructor(e){e.inputs={number1:{type:r.input},number2:{type:r.input}},e.blockType="AddBlock",super(e),this.prohibitBlock=!0,this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line green">
                <div class="block-input" id="input-number1" drag="true"></div>
                <p class="block-text" drag="true">+</p>
                <div class="block-input" id="input-number2" drag="true"></div>
            </div>
            `.replace(" ","")}}class D extends u{constructor(e){e.inputs={next:{type:r.next}},e.blockType="StartBlock",super(e),this.defaultInsert="next",this.hat=!0}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line block-hat yellow">
                <p class="block-text" drag="true">程序开始运行</p>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}class j extends u{constructor(e){e.inputs={y:{type:r.input},x:{type:r.input},next:{type:r.next}},e.blockType="MoveBlock",super(e),this.defaultInsert="next",this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="block-line blue">
                <p class="block-text" drag="true">移动到</p>
                <div class="block-input" id="input-x" drag="true"></div>
                <div class="block-input" id="input-y" drag="true"></div>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}class $ extends u{constructor(e){e.inputs={condition:{type:r.input},if:{type:r.method},else:{type:r.method},next:{type:r.next}},e.blockType="IfBlock",super(e),this.defaultInsert="if",this.hat=!1}create(){this.element.innerHTML=`
            <div id="block-display" drag="true" class="yellow"> 
                <div class="block-line block-method">
                    <p class="block-text" drag="true">如果</p>
                    <div class="block-input" id="input-condition" drag="true"></div>
                    <p class="block-text" drag="true">那么</p>
                </div>
                <div class="block-block-input" id="input-if" drag="true"></div>
                
                <div class="block-line block-method">
                    <p class="block-text" drag="true">否则</p>
                </div>
                <div class="block-block-input" id="input-else"></div>
                <div class="block-line block-method">
                    <p class="block-text" drag="true">end</p>
                </div>
            </div>
            <div class="next-input" id="input-next"></div>
            `.replace(" ","")}}const b=Object.freeze(Object.defineProperty({__proto__:null,AddBlock:z,IfBlock:$,MoveBlock:j,StartBlock:D},Symbol.toStringTag,{value:"Module"}));class X{constructor(e){this.space=e}load(e){console.log(e.element),this.space.blocks=e.block,this.space.blockSpace.innerHTML="",e.element.forEach(t=>{this.space.blockSpace.appendChild(t)})}}class Y{constructor(){this.element=[],this.block=[]}load(e){this.block=e.blocks,e.blockSpace.childNodes.forEach(t=>{this.element.push(t)})}}let m=new T({element:document.getElementById("blockDiv"),zoomElement:document.getElementById("zoom")});for(const s in b)m.registerBlock(b[s]),m.addBlock(new m.blockClasses[s]({create:!0}));let A=new X(m),x=new Y;x.load(m);A.load(x);window.app=m;
