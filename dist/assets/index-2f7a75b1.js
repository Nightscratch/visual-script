(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))n(l);new MutationObserver(l=>{for(const i of l)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(l){const i={};return l.integrity&&(i.integrity=l.integrity),l.referrerPolicy&&(i.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?i.credentials="include":l.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(l){if(l.ep)return;l.ep=!0;const i=t(l);fetch(l.href,i)}})();function X(s,e){return[s.getBoundingClientRect(),e.getBoundingClientRect()]}const g=(s,e,t,n)=>{const l=s.getBoundingClientRect();O(s,e,l.left+t,l.top+n)},O=(s,e,t,n)=>{const l=e.getBoundingClientRect();s.style.left=`${e.scrollLeft+t-l.left}px`,s.style.top=`${e.scrollTop+n-l.top}px`},$=(s,e)=>{g(s,e,0,0)},Y=(s,e)=>{const[t,n]=X(s,e);return{top:t.top-n.top+e.scrollTop,left:t.left-n.left+e.scrollLeft}},q=(s,e=!1)=>{let t,n,l=0,i=0,o=s.space;o.element.getBoundingClientRect();let r=!1;const u=c=>{o.dropDown.close(),!((!s.draggableBlock.includes(c.target)||c.button!==0)&&!e)&&(r=!0,s.element.getBoundingClientRect(),s.parentInput&&$(s.element,o.blockSpace),s.element.classList.add("drag-block"),s.dragStart(),t=c.clientX,n=c.clientY,s.element.style.left?(l=parseInt(s.element.style.left),i=parseInt(s.element.style.top)):(l=0,i=0),j())},m=c=>{if(r){var H=c.clientX-t,R=c.clientY-n;l+=H/o.zoom,i+=R/o.zoom,s.element.style.left=`${l}px`,s.element.style.top=`${i}px`,t=c.clientX,n=c.clientY,c.preventDefault()}},h=()=>{r=!1,s.element.classList.remove("drag-block"),s.dragEnd(),o.setPlaceholder(),A()},j=()=>{document.addEventListener("mousemove",m),document.addEventListener("mouseup",h)},A=()=>{document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",h)};s.element.addEventListener("mousedown",u);function M(c){document.removeEventListener("mousemove",M),u(c),e=!1}e&&document.addEventListener("mousemove",M)};function J(s){var e=!1,t,n;s.element.addEventListener("mousedown",l),s.element.addEventListener("mouseup",i),s.element.addEventListener("mousemove",o);function l(r){r.target==s.scrollPlaceholder&&(e=!0,t=r.clientX,n=r.clientY,r.preventDefault())}function i(){e=!1}function o(r){if(e){var u=r.clientX-t,m=r.clientY-n;s.element.scrollLeft-=u,s.element.scrollTop-=m,t=r.clientX,n=r.clientY,r.preventDefault()}}s.element.addEventListener("mouseleave",()=>{e=!1})}class Z{constructor(){this.element=document.createElement("div"),this.element.classList.add("drop-down"),this.close(),document.addEventListener("click",e=>{this.close()})}createButton(e){const t=document.createElement("button");return t.innerText=e.text,t.addEventListener("click",e.click),t}setButton(e){this.element.innerHTML="",e.forEach(t=>{this.element.appendChild(this.createButton(t))}),this.element.style.display="block"}close(){this.element.style.display="none"}moveTo(e,t){this.element.style.left=`${e}px`,this.element.style.top=`${t}px`}}const F=(s,e)=>{s.element.addEventListener("contextmenu",t=>{s.draggableBlock.includes(t.target)&&(t.preventDefault(),e.moveTo(t.clientX,t.clientY),e.setButton([{text:"复制积木",click:()=>{s.copy()}},{text:"删除积木",click:()=>{s.delete()}}]))})},U=s=>{s.element.addEventListener("contextmenu",e=>{e.target==s.scrollPlaceholder&&(e.preventDefault(),s.dropDown.moveTo(e.clientX,e.clientY),s.dropDown.setButton([{text:"删除全部",click:()=>{s.clean()}},{text:"整理积木",click:()=>{s.arrange()}}]))})},W=s=>{let e=document.createElement("div");return e.classList.add("zoom-list"),s.forEach(t=>{let n=document.createElement("button");n.classList.add("zoom-btn"),n.innerText=t.text,n.addEventListener("click",()=>{t.click()}),e.appendChild(n)}),e};class G{constructor(e){this.blocks=[],this.blockClasses={},this.zoom=1,this.element=e.element,e.zoomElement.appendChild(W([{text:"＋",click:()=>{this.zoom+=.4,this.setZoom()}},{text:"＝",click:()=>{this.zoom=1,this.setZoom()}},{text:"－",click:()=>{this.zoom-=.4,this.setZoom()}}])),this.scrollPlaceholder=document.createElement("div"),this.scrollPlaceholder.classList.add("placeholder"),this.element.append(this.scrollPlaceholder),this.blockSpace=document.createElement("div"),this.blockSpace.classList.add("block-container-space"),this.element.appendChild(this.blockSpace),this.dropDown=new Z,document.body.appendChild(this.dropDown.element),U(this),J(this),this.setZoom()}setZoom(e=this.zoom){this.zoom=Math.min(Math.max(e,.5),2.5),this.blockSpace.setAttribute("style",`zoom:${this.zoom}`),this.scrollPlaceholder.setAttribute("style",`zoom:${this.zoom}`),this.setPlaceholder()}setPlaceholder(){let e=this.element.scrollLeft,t=this.element.scrollTop;this.scrollPlaceholder.style.display="none",this.scrollPlaceholder.style.height=`${(this.element.scrollHeight+this.element.clientHeight/2)/this.zoom}px`,this.scrollPlaceholder.style.width=`${(this.element.scrollWidth+this.element.clientWidth/2)/this.zoom}px`,this.scrollPlaceholder.style.display="block",this.element.scrollLeft=e,this.element.scrollTop=t}addBlock(e,t=!1){e.space=this,this.blocks.push(e),this.blockSpace.appendChild(e.element),q(e,t),F(e,this.dropDown)}removeBlock(e){this.blocks.splice(this.blocks.indexOf(e),1)}registerBlock(e){let t=new e({create:!0});this.blockClasses[t.blockType]=e}clean(){return new Promise(e=>{this.blockSpace.innerHTML="",this.blocks=[],e()})}arrange(){return new Promise((e,t)=>{let n=10,l=10;for(const[i,o]of Object.entries(this.blocks))o.parentInput||(o.element.style.left=`${n}px`,o.element.style.top=`${l}px`,l+=o.element.clientHeight+10);this.setPlaceholder(),e()})}}class K{constructor(e){this.space=e}load(e){console.log(e.element),this.space.blocks=e.block,this.space.blockSpace.innerHTML="",e.element.forEach(t=>{this.space.blockSpace.appendChild(t)})}empty(){this.space.blocks=[],this.space.blockSpace.innerHTML=""}}class w{constructor(){this.element=[],this.block=[]}load(e){this.block=e.blocks,console.log("space.blockSpace.childNodes",e.blockSpace.childNodes),e.blockSpace.childNodes.forEach(t=>{console.log(t),this.element.push(t)})}compile(){return new Promise(e=>{let t="";for(const[n,l]of Object.entries(this.block))l.parentInput||(t+=l.toCode(!0));e(t)})}}const V=`<div class="sprite">\r
    <p id="name"></p>\r
    <button id="del">删除</button>\r
    <button id="rename">重命名</button>\r
</div>`,E=s=>{let e=document.createElement("div");return e.innerHTML=s,e.firstChild};class x{constructor(e){e.block instanceof w?this.block=e.block:this.block=new w,this.element=E(V),this.setName(e.spriteName)}setOnClick(e){this.element.addEventListener("click",t=>e(t))}setName(e){this.spriteName=e,this.element.querySelector("#name").innerText=this.spriteName}remove(){this.element.remove()}}class Q{constructor(e){this.sprites=e.sprites,this.blockManager=e.blockManager,this.element=e.element,this.autoSelectSprite()}addSprite(e){this.sprites.push(e),this.element.appendChild(e.element),e.setOnClick(t=>{let n=t.target.getAttribute("id");n=="del"?this.removeSprite(e):n=="rename"?this.setSpriteName(String(prompt("取名",e.spriteName)),e):this.setSelectedSprite(e)}),this.autoSelectSprite()}setSpriteName(e,t){for(const n of this.sprites)if(n.spriteName==e){alert(`已有名叫${e}的角色了`);return}t.setName(e)}autoSelectSprite(){this.sprites.length==0?this.setSelectedSprite(null):this.setSelectedSprite(0)}save(){this.selectedSprite&&this.selectedSprite.block.load(this.blockManager.space)}removeSprite(e){e.remove(),this.sprites.splice(this.sprites.indexOf(e),1),this.selectedSprite==e&&this.sprites.length==0&&this.autoSelectSprite()}setSelectedSprite(e){let t=null;if(this.selectedSprite&&(this.selectedSprite.block.load(this.blockManager.space),this.selectedSprite.element.classList.remove("sprite-active")),typeof e=="number")t=this.sprites[e];else if(e instanceof x)t=e;else{this.selectedSprite=null,this.blockManager.empty();return}t.element.classList.add("sprite-active"),this.selectedSprite=t,this.blockManager.load(t.block)}}const _='<li><button id="btn"></button></li>';class ee{constructor(e){this.categorizes=[],this.element=e.element,this.modelElement=e.modelElement,this.space=e.space,e.categorizes&&(e.categorizes.forEach(t=>{this.addCategorize(t)}),this.selectedCategorize=e.categorizes[0],this.setModel())}setModel(){if(this.selectedCategorize){this.modelElement.innerHTML="";for(const e of this.selectedCategorize.blocks){let t=new e({create:!0});t.element.classList.add("model-block"),this.modelElement.appendChild(t.element),console.log("b.element",t.element),t.element.addEventListener("mousedown",n=>{let l=new e({create:!0}),i=t.element.getBoundingClientRect();O(l.element,this.space.element,i.left,i.top),this.space.addBlock(l,!0)})}}}addCategorize(e){this.categorizes.push(e),e.element.addEventListener("click",()=>{this.selectedCategorize=e,this.setModel()}),this.element.appendChild(e.element)}}class v{constructor(e){this.blocks=e.blocks,this.element=E(_),this.setName(e.categorizeName)}setName(e){this.categorizeName=e,this.element.querySelector("#btn").innerText=this.categorizeName}}class te{constructor(e){this.engine=e}async compile(){const e=this.engine.spriteManager.sprites.map(n=>n.block.compile());return(await Promise.all(e)).join("")}}const z=(s,e)=>{const t=s.getBoundingClientRect(),n=e.getBoundingClientRect();return{dis:Math.round(Math.abs(n.left-t.left)+Math.abs(n.top-t.top)),e1:t,e2:n}};function k(s,e){const t=document.createElement("div");return t.id="block-display",t.setAttribute("class",s),t.setAttribute("drag","true"),e.forEach(n=>{t.appendChild(n)}),t}function f(s,e){const t=document.createElement("div");return t.classList.add("block-line"),s&&t.classList.add("block-method"),e.forEach(n=>{t.appendChild(n)}),t}function p(s){const e=document.createElement("p");return e.classList.add("block-text"),e.setAttribute("drag","true"),e.textContent=s,e}function b(s){const e=document.createElement("div");return e.classList.add("block-input"),e.id=`input-${s}`,e.setAttribute("drag","true"),e}function N(s){const e=document.createElement("div");return e.classList.add("block-block-input"),e.id=`input-${s}`,e.setAttribute("drag","true"),e}function se(){const s=document.createElement("div");return s.classList.add("next-input"),s.id="input-next",s}function ne(){const s=document.createElement("input");return s.classList.add("text-input"),s.id="text-input",s}function P(){const s=document.createElement("div");return s.classList.add("block-br"),s.id="br",s}var a=(s=>(s[s.method=0]="method",s[s.next=1]="next",s[s.input=2]="input",s))(a||{}),y=(s=>(s[s.prevent=0]="prevent",s[s.normal=1]="normal",s[s.kick=2]="kick",s))(y||{});class d{constructor(e){this.parentInput=null,this.draggableBlock=[],!e.create&&e.element&&(this.element=e.element),this.inputs=e.inputs,this.element||(this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.create(this.element),this.element.appendChild(this.constructor.baseHtml.cloneNode(!0)),this.element.appendChild(se())),this.blockType=e.blockType,this.hat=e.hat,this.defaultInsert=e.defaultInsert,this.getInput(),this.setBr()}create(e){}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.draggableBlock.push(this.element),this.displayElement=this.element.querySelector('[id="block-display"]')}setBr(){this.element.querySelectorAll('[id="br"]').forEach(e=>{console.log(e),e.addEventListener("click",t=>{e.classList.toggle("br-open")})})}dragEnd(){const e=this.getSmallestChild(),t=[];for(const n of this.space.blocks)if(n!=this&&!this.element.contains(n.element)){if(!this.hat)for(const[l,i]of Object.entries(n.inputs)){let o=n.newInputCheack(this,l),r=this.enterInputCheack(n,l);if(o!=0&&r!=0){const u=z(i.element,this.element);u.dis<25&&t.push({inputId:l,distance:u.dis,block:n,type:Math.max(r,o),down:null})}}for(const[l,i]of Object.entries(this.inputs))if([1,0].includes(i.type)&&!n.parentInput&&!n.hat){let o,r;i.type==1?(o=e,r=e):(o=this.inputs[l],r=this);let u=n.enterInputCheack(r,l),m=r.newInputCheack(n,l);if(u!=0&&m!=0){let h=z(n.element,o.element);Math.abs(h.e1.left-h.e2.left)<25&&Math.abs(h.e1.top-h.e2.bottom)<25&&t.push({inputId:l,distance:h.dis,block:n,type:Math.max(m,u),down:r})}}}if(t.length>0){const n=t.reduce((l,i)=>i.distance<l.distance?i:l);this.handleConnect(n.block.inputs[n.inputId],n)}}newInputCheack(e,t){return 1}enterInputCheack(e,t){return 1}dragStart(){this.element.classList.remove("input-block"),this.space.blockSpace.appendChild(this.element),this.detachFromParent()}solitary(){$(this.element,this.space.blockSpace),this.dragStart()}enterInput(e){e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e,e.value=this}cheackAndEnterInput(e,t,n){this.enterInputCheack(e,t)&&e.newInputCheack(this,t)?this.enterInput(e.inputs[t]):n&&n()}getSmallestChild(e="next"){let t=this;for(;t.inputs[e]&&t.inputs[e].value instanceof d;)t=t.inputs[e].value,e="next";return t}handleConnect(e,t){if(t.down&&t.block!=this)t.block.enterInput(t.down.inputs[t.inputId]);else{console.log(t,e);let n=null;e.value&&(n=e.value,n.solitary()),this.enterInput(e),n&&(t.type==2?g(n.element,this.space.element,25,25):this.defaultInsert&&(n=n,this.inputs[this.defaultInsert].type==0&&!(this.inputs[this.defaultInsert].value instanceof d)?n.cheackAndEnterInput(this,this.defaultInsert,()=>g(n.element,this.space.element,25,25)):n.cheackAndEnterInput(this.getSmallestChild(),"next",()=>g(n.element,this.space.element,25,25))))}}detachFromParent(){this.parentInput&&(this.parentInput.value=null),this.parentInput=null}clone(e){let t=this.element.cloneNode(!0);if(t.querySelectorAll('div[id^="input-"]').forEach(i=>{i.innerHTML=""}),e){t.classList.remove("input-block");const i=Y(this.element,this.space.blockSpace);t.style.left=`${i.left+25}px`,t.style.top=`${i.top+25}px`}let l=new this.space.blockClasses[this.blockType]({create:!1,element:t});return e&&(l.parentInput=null),l}copy(e=!0){let t=this.clone(e);return this.space.addBlock(t),Object.keys(this.inputs).forEach(n=>{if(this.inputs[n].value instanceof d){let l=this.inputs[n].value.copy(!1);t.inputs[n].value=l,l.enterInput(t.inputs[n])}else t.inputs[n].value=this.inputs[n].value}),t}delete(e=!0){e&&this.element.remove(),this.parentInput&&(this.parentInput.value=null),this.space.removeBlock(this),Object.keys(this.inputs).forEach(t=>{this.inputs[t].value instanceof d&&this.inputs[t].value.delete(!1)})}toCode(e=!0){let t={};return Object.keys(this.inputs).forEach(n=>{this.inputs[n].value instanceof d&&(t[n]=this.inputs[n].value.toCode(!1))}),this.compile(t)}toJson(e=!0){let t={blockType:this.blockType,inputs:{}};return e&&(t.left=parseInt(this.element.style.left),t.top=parseInt(this.element.style.top)),this.saveProperties(t),Object.keys(this.inputs).forEach(n=>{this.inputs[n].value instanceof d&&(t.inputs[n]={type:"block",value:this.inputs[n].value.toJson(!1)})}),t}saveProperties(e){}loadProperties(e){}loadInputs(e,t=!0){t&&(this.element.style.left=`${e.left}px`,this.element.style.top=`${e.top}px`),this.loadProperties(e);for(const[n,l]of Object.entries(e.inputs))if(l.type=="block"){let i=l.value,o=new this.space.blockClasses[i.blockType]({create:!0});this.space.addBlock(o),l.value&&o.loadInputs(l.value,!1).enterInput(this.inputs[n])}return this}}class D extends d{constructor(e){super(e),this.hat=!1}enterInputCheack(e,t){return!a.input==e.inputs[t].type?y.prevent:y.kick}}class S extends D{constructor(e){e.inputs={number1:{type:a.input},number2:{type:a.input}},e.blockType="AddBlock",super(e)}compile(e){return`(${e.number1} + ${e.number2})`}}S.baseHtml=k("green",[f(!1,[b("number1"),p("+"),b("number2")])]);class L extends D{constructor(e){e.inputs={},e.blockType="NumberBlock",super(e)}compile(e){return`(${e.number1} + ${e.number2})`}}L.baseHtml=k("green",[f(!1,[p("int("),ne(),p(")")])]);class C extends d{constructor(e){e.inputs={next:{type:a.next}},e.blockType="StartBlock",super(e),this.defaultInsert="next",this.hat=!0}compile(e){return`function start(){${e.next}}`}}C.baseHtml=k("block-line block-hat yellow",[p("当绿旗被点击时")]);class I extends d{constructor(e){e.inputs={y:{type:a.input},x:{type:a.input},next:{type:a.next}},e.blockType="MoveBlock",super(e),this.defaultInsert="next",this.hat=!1}compile(e){return""}}I.baseHtml=k("blue",[f(!1,[p("移动"),P(),b("x"),P(),b("y")])]);class B extends d{constructor(e){e.inputs={condition:{type:a.input},if:{type:a.method},else:{type:a.method},next:{type:a.next}},e.blockType="IfBlock",super(e),this.defaultInsert="if",this.hat=!1}compile(e){return""}}B.baseHtml=k("yellow",[f(!0,[p("如果"),b("condition"),p("那么")]),N("if"),f(!0,[p("否则")]),N("else"),f(!0,[p("end")])]);const T=Object.freeze(Object.defineProperty({__proto__:null,AddBlock:S,IfBlock:B,MoveBlock:I,NumberBlock:L,StartBlock:C},Symbol.toStringTag,{value:"Module"}));class le{constructor(e){this.engine=e}async package(){const e={sprites:[]};return await Promise.all(this.engine.spriteManager.sprites.map(t=>this.blocksToJson(t.block.block).then(n=>e.sprites.push({code:n,spriteName:t.spriteName})))),JSON.stringify(e)}blocksToJson(e){const t=[];for(const[n,l]of Object.entries(e))l.parentInput||t.push(l.toJson());return Promise.resolve(t)}}const ie=`<div class="work-space">\r
    <ul class="nav">\r
        <li>\r
            <p>Scratch 加强版</p>\r
        </li>\r
        <li class="btn">\r
            <p>文件</p>\r
        </li>\r
        <li class="btn">\r
            <p>设置</p>\r
        </li>\r
        <li class="btn">\r
            <p>帮助</p>\r
        </li>\r
    </ul>\r
    <div class="edit-space">\r
        <div class="code-space">\r
            <div class="code-tool-box">\r
                <ul class="code-tool-box-categorize" id="tool-box">\r
                </ul>\r
                <div class="code-model" id="code-model">\r
\r
                </div>\r
            </div>\r
            <div id="zoom"></div>\r
            <div id="block-div" class="block-space"></div>\r
        </div>\r
\r
        <div class="display-space">\r
            <div class="view-port">\r
\r
            </div>\r
            <div class="sprite-list" id="sprite-list">\r
                <button id="add">+</button>\r
                <button id="run">run</button>\r
            </div>\r
        </div>\r
    </div>\r
</div>`;class oe{constructor(e){e.element.appendChild(E(ie)),this.codeSpace=new G({element:document.getElementById("block-div"),zoomElement:document.getElementById("zoom")}),this.blockManager=new K(this.codeSpace),this.spriteManager=new Q({element:document.getElementById("sprite-list"),sprites:[],blockManager:this.blockManager}),this.compiler=new te(this),this.packager=new le(this),this.toolBox=new ee({space:this.codeSpace,element:document.getElementById("tool-box"),modelElement:document.getElementById("code-model"),categorizes:[new v({categorizeName:"运动",blocks:[I]}),new v({categorizeName:"控制",blocks:[B,C]}),new v({categorizeName:"运算",blocks:[S,L]})]});for(const t in T)this.codeSpace.registerBlock(T[t]);this.addEventLister()}addEventLister(){document.getElementById("add").addEventListener("click",()=>{this.spriteManager.addSprite(new x({spriteName:"角色"+this.spriteManager.sprites.length}))}),document.getElementById("run").addEventListener("click",()=>{this.compiler.compile().then(e=>{console.log(e)})})}}const re=new oe({element:document.getElementById("app")});re.spriteManager.addSprite(new x({spriteName:"角色0"}));
