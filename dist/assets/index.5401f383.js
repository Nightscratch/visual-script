(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))l(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&l(o)}).observe(document,{childList:!0,subtree:!0});function n(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerpolicy&&(i.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?i.credentials="include":t.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(t){if(t.ep)return;t.ep=!0;const i=n(t);fetch(t.href,i)}})();const u=s=>s.getBoundingClientRect();function p(s,e){let n=u(s),l=u(e);s.style.left=`${n.left-l.left}px`,s.style.top=`${n.top-l.top}px`}function y(s){let e=!1,n=0,l=0,t=null;function i(r){!s.draggableBlock.includes(r.target)||(e=!0,t=u(s.element),s.parentInput&&p(s.element,s.space.element),s.displayElement.classList.add("drag-block"),s.dragStart(),n=r.clientX-t.left,l=r.clientY-t.top,h())}function o(r){if(e){const g=r.clientX-n,v=r.clientY-l;s.element.style.left=`${g}px`,s.element.style.top=`${v}px`}}function d(){e=!1,s.displayElement.classList.remove("drag-block"),s.dragEnd(),f()}function h(){document.addEventListener("mousemove",o),document.addEventListener("mouseup",d)}function f(){document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",d)}s.element.addEventListener("mousedown",i)}const E=s=>{let e=null;s.element.addEventListener("contextmenu",n=>{if(!s.draggableBlock.includes(n.target))return;if(n.preventDefault(),e){document.body.removeChild(e),e=null;return}e=document.createElement("div"),e.style.position="absolute",e.style.left=`${n.clientX}px`,e.style.top=`${n.clientY}px`;const l=document.createElement("button");l.innerText="\u590D\u5236",l.addEventListener("click",()=>{s.copy()}),e.appendChild(l);const t=document.createElement("button");t.addEventListener("click",()=>{s.delete()}),t.innerText="\u5220\u9664",e.appendChild(t),document.body.appendChild(e)}),document.addEventListener("click",n=>{e&&!s.element.contains(n.target)&&(document.body.removeChild(e),e=null)})};class b{constructor(e){this.blocks=[],this.blockClasses={},this.element=e.element}addBlock(e){e.space=this,this.blocks.push(e),this.element.appendChild(e.element),y(e),E(e)}registerBlock(e){this.blockClasses[e.name]=e}}const L=(s,e)=>{const n=u(s),l=u(e);return Math.round(Math.abs(l.left-n.left)+Math.abs(l.top-n.top))};class a{constructor(e){this.parentInput=null,this.draggableBlock=[],!e.create&&e.element&&(this.element=e.element)}getInput(){Object.keys(this.inputs).forEach(e=>{this.inputs[e].element=this.element.querySelector(`[id="input-${e}"]`)}),this.draggableBlock=Array.from(this.element.querySelectorAll('[drag="true"]')),this.displayElement=this.element.querySelector('[id="block-display"]')}dragEnd(){console.log("dragEnd");const e=[];if(this.space.blocks.forEach(n=>{n!==this&&Object.entries(n.inputs).forEach(([l,t])=>{const i=L(t.element,this.element);i<25&&e.push({dis:i,id:l,block:n})})}),e.length>0){const n=e.reduce((l,t)=>t.dis<l.dis?t:l);this.handleConnect(n.id,n.block.inputs[n.id],n.block)}}dragStart(){this.element.classList.remove("input-block"),this.space.element.appendChild(this.element),this.parentInput&&(this.parentInput.value=null)}solitary(){this.parentInput&&(this.parentInput.value=null),p(this.element,this.space.element),this.dragStart()}enterInput(e){e.value=this,e.element.appendChild(this.element),this.element.classList.add("input-block"),this.parentInput=e}getSmallestChild(){let e=this;for(;e.inputs.next.value instanceof a;)e=e.inputs.next.value;return e}handleConnect(e,n,l){let t=null;n.value&&(t=n.value,t.solitary()),this.enterInput(n),t&&this.inputs.next&&t.enterInput(this.getSmallestChild().inputs.next)}clone(){return new this.space.blockClasses[this.constructor.name]({create:!0})}copy(e=!0){console.log("\u590D\u5236\u79EF\u6728",this.element,this.inputs),e&&(this.parentInput=null);let n=this.clone();return this.space.addBlock(n),Object.keys(this.inputs).forEach(l=>{if(this.inputs[l].value instanceof a){console.log(this.inputs[l]);let t=this.inputs[l].value.copy(!1);n.inputs[l].value=t,t.enterInput(n.inputs[l])}else n.inputs[l].value=this.inputs[l].value}),n}delete(){}}class m extends a{constructor(e){super(e),this.inputs={step:{type:"input",value:null,element:null},next:{type:"next",value:null,element:null}},this.blockName="moveBlock",this.create()}create(){this.element=document.createElement("div"),this.element.setAttribute("class","block"),this.element.innerHTML=`
        <div id="block-display" drag="true">
            <p class="block-text" drag="true">action</p>
            <div class="block-input" id="input-step"></div>
        </div>
        <div class="next-input" id="input-next"></div>
        `.replace(" ",""),this.getInput()}}let c=new b({element:document.getElementById("blocklyDiv")});c.registerBlock(m);c.addBlock(new m({create:!0}));window.app=c;
